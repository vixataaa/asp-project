<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\vixat\Desktop\GitRepos\asp-project\src\SecondHand\SecondHand.Services.Data\AdvertisementsService.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using SecondHand.Services.Data.Contracts;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using SecondHand.Data.Models;
using SecondHand.Data.Repositories.Contracts;
using SecondHand.Data.Contracts;
using SecondHand.Services.Data.Common;
using System.Reflection;
using Bytes2you.Validation;

namespace SecondHand.Services.Data
{
    public class AdvertisementsService : IAdvertisementsService
    {
        private readonly ICategoryRepository categories;
        private readonly IAdvertisementsRepository advertisements;
        private int lastQueryRecordsCount;
        private readonly IUsersRepository users;

        public AdvertisementsService(IAdvertisementsRepository advertisements, ICategoryRepository categories, IUsersRepository users)
        {
            Guard.WhenArgument(advertisements, &quot;advertisements&quot;).IsNull().Throw();
            Guard.WhenArgument(categories, &quot;categories&quot;).IsNull().Throw();
            Guard.WhenArgument(users, &quot;users&quot;).IsNull().Throw();

            this.advertisements = advertisements;
            this.categories = categories;
            this.users = users;
            this.lastQueryRecordsCount = 0;
        }

        public int LastQueryRecordsCount
        {
            get
            {
                return this.lastQueryRecordsCount;
            }
        }

        public void CreateAdvertisement(Advertisement adv, string categoryName)
        {
            var category = this.categories.GetCategoryByName(categoryName);

            if (category != null)
            {
                adv.Category = category;

                foreach (var photo in adv.Photos)
                {
                    photo.Advertisement = adv;
                }

                this.advertisements.Add(adv);
            }
        }

        public void Edit(Advertisement adv)
        {
            this.advertisements.Update(adv);
        }

        public void Remove(Guid id)
        {
            var adv = this.advertisements.GetById(id);

            if (adv != null)
            {
                this.advertisements.Delete(adv);
            }
        }

        public IEnumerable&lt;Advertisement&gt; GetAdvertisements()
        {
            return this.advertisements.All.ToList();
        }

        public IEnumerable&lt;Advertisement&gt; GetAdvertisements(int pageNumber = 1, int pageSize = 5, string query = &quot;&quot;)
        {
            var result = this.GetAdvertisements(pageNumber, pageSize, query, &quot;&quot;, SortType.Ascending, &quot;&quot;);

            return result;
        }

        public IEnumerable&lt;Advertisement&gt; GetAdvertisements(int pageNumber = 1, int pageSize = 5, string query = &quot;&quot;,
            string sortProperty = &quot;&quot;, SortType sortType = SortType.Ascending, string category = &quot;&quot;)
        {
            var result = this.advertisements.All;

            if (!string.IsNullOrEmpty(query))
            {
                result = result.Where(x =&gt;
                    x.Title.ToLower().Contains(query.ToLower()) ||
                    x.Description.ToLower().Contains(query.ToLower()) ||
                    x.Category.Name.ToLower().Contains(query.ToLower()));
            }

            if (!string.IsNullOrEmpty(category))
            {
                result = result.Where(x =&gt; x.Category.Name.ToLower() == category.ToLower());
            }

            switch (sortProperty.ToLower())
            {
                case &quot;title&quot;:
                    if (sortType == SortType.Ascending)
                    {
                        result = result.OrderBy(x =&gt; x.Title);
                    }
                    else
                    {
                        result = result.OrderByDescending(x =&gt; x.Title);
                    }
                    break;
                case &quot;price&quot;:
                    if (sortType == SortType.Ascending)
                    {
                        result = result.OrderBy(x =&gt; x.Price);
                    }
                    else
                    {
                        result = result.OrderByDescending(x =&gt; x.Price);
                    }
                    break;
                default:
                    if (sortType == SortType.Ascending)
                    {
                        result = result.OrderBy(x =&gt; x.CreatedOn);
                    }
                    else
                    {
                        result = result.OrderByDescending(x =&gt; x.CreatedOn);
                    }
                    break;
            }

            this.lastQueryRecordsCount = result.Count();

            result = result
                .Skip((pageNumber - 1) * pageSize)
                .Take(pageSize);

            return result.ToList();
        }

        public Advertisement GetById(Guid id)
        {
            return this.advertisements.GetById(id);
        }

        public IEnumerable&lt;Advertisement&gt; GetUserAdvertisements(string username)
        {
            return this.advertisements.All.Where(x =&gt; x.AddedBy.UserName == username).ToList();
        }

        public void Remove(Advertisement adv)
        {
            this.advertisements.Delete(adv);
        }

        public IEnumerable&lt;Advertisement&gt; AllAndDeleted()
        {
            return this.advertisements.AllAndDeleted.ToList();
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[23,9,23,135,1],[24,9,24,10,1],[25,13,25,83,1],[26,13,26,75,1],[27,13,27,65,1],[29,13,29,50,1],[30,13,30,42,1],[31,13,31,32,1],[32,13,32,44,1],[33,9,33,10,1],[38,13,38,14,0],[39,17,39,51,0],[40,13,40,14,0],[44,9,44,10,0],[45,13,45,76,0],[47,13,47,34,0],[48,13,48,14,0],[49,17,49,41,0],[51,17,51,24,0],[51,26,51,35,0],[51,36,51,38,0],[51,39,51,49,0],[52,17,52,18,0],[53,21,53,47,0],[54,17,54,18,0],[56,17,56,46,0],[57,13,57,14,0],[58,9,58,10,0],[61,9,61,10,1],[62,13,62,45,1],[63,9,63,10,1],[66,9,66,10,1],[67,13,67,55,1],[69,13,69,29,1],[70,13,70,14,1],[71,17,71,49,1],[72,13,72,14,1],[73,9,73,10,1],[76,9,76,10,1],[77,13,77,53,1],[78,9,78,10,1],[81,9,81,10,0],[82,13,82,106,0],[84,13,84,27,0],[85,9,85,10,0],[89,9,89,10,0],[90,13,90,50,0],[92,13,92,46,0],[93,13,93,14,0],[94,17,97,74,0],[98,13,98,14,0],[100,13,100,49,0],[101,13,101,14,0],[102,17,102,93,0],[103,13,103,14,0],[105,13,105,44,0],[108,21,108,56,0],[109,21,109,22,0],[110,25,110,63,0],[111,21,111,22,0],[113,21,113,22,0],[114,25,114,73,0],[115,21,115,22,0],[116,21,116,27,0],[118,21,118,56,0],[119,21,119,22,0],[120,25,120,63,0],[121,21,121,22,0],[123,21,123,22,0],[124,25,124,73,0],[125,21,125,22,0],[126,21,126,27,0],[128,21,128,56,0],[129,21,129,22,0],[130,25,130,67,0],[131,21,131,22,0],[133,21,133,22,0],[134,25,134,77,0],[135,21,135,22,0],[136,21,136,27,0],[139,13,139,57,0],[141,13,143,33,0],[145,13,145,36,0],[146,9,146,10,0],[149,9,149,10,1],[150,13,150,52,1],[151,9,151,10,1],[154,9,154,10,1],[155,13,155,96,1],[156,9,156,10,1],[159,9,159,10,1],[160,13,160,45,1],[161,9,161,10,1],[164,9,164,10,1],[165,13,165,63,1],[166,9,166,10,1]]);
    </script>
  </body>
</html>