<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\vixat\Desktop\GitRepos\asp-project\src\SecondHand\SecondHand.Web\Areas\Chats\Controllers\ChatsController.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using AutoMapper;
using Bytes2you.Validation;
using SecondHand.Services.Data.Contracts;
using SecondHand.Services.Notifications.Contracts;
using SecondHand.Web.Areas.Chats.Models.Chats;
using SecondHand.Web.Infrastructure;
using SecondHand.Web.Infrastructure.Attributes;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Web;
using System.Web.Mvc;

namespace SecondHand.Web.Areas.Chats.Controllers
{
    [Authorize]
    [SaveChanges]
    public class ChatsController : Controller
    {
        private readonly IChatsService chatService;
        private readonly IMapper mapper;
        private readonly IChatNotificationsService chatNotificationService;
        private readonly IUsersService userService;

        public ChatsController(IChatsService chatService, IChatNotificationsService chatNotificationService, IUsersService userService, IMapper mapper)
        {
            Guard.WhenArgument(chatService, &quot;chatService&quot;).IsNull().Throw();
            Guard.WhenArgument(mapper, &quot;mapper&quot;).IsNull().Throw();
            Guard.WhenArgument(chatNotificationService, &quot;chatNotificationService&quot;).IsNull().Throw();
            Guard.WhenArgument(userService, &quot;userService&quot;).IsNull().Throw();

            this.chatService = chatService;
            this.mapper = mapper;
            this.chatNotificationService = chatNotificationService;
            this.userService = userService;
        }

        public ActionResult Index()
        {
            var loggedUser = this.ControllerContext.HttpContext.User.Identity.Name;

            var chats = this
                .chatService
                .GetUserChats(loggedUser)
                .Select(x =&gt; this.mapper.Map&lt;ChatListItemViewModel&gt;(x))
                .ToList();

            foreach (var chat in chats)
            {
                if (chat.NotifiedUsers.Any(x =&gt; x.ToLower() == loggedUser.ToLower()))
                {
                    chat.IsRead = false;
                }
                else
                {
                    chat.IsRead = true;
                }
            }

            var viewModel = new UserChatsViewModel
            {
                Chats = chats
                    .Where(x =&gt; x.ModifiedOn.HasValue)
                    .OrderBy(x =&gt; x.ModifiedOn.Value)
                    
            };

            return this.View(viewModel);
        }

        [SaveChanges]
        public ActionResult ChatRoom(string username, Guid advertisementId)
        {
            var loggedUser = User.Identity.Name;
            var destinationUser = username;

            var participants = new string[] { loggedUser, destinationUser };

            var chat = this.chatService.GetChat(advertisementId, participants);

            if (chat == null)
            {
                return this.RedirectToAction(&quot;Details&quot;, &quot;Advertisements&quot;, new { id = advertisementId.ToString(), area = &quot;&quot; });
            }

            var viewModel = this.mapper.Map&lt;ChatRoomViewModel&gt;(chat);
            
            this.chatNotificationService.ClearChatNotification(chat, loggedUser);

            return this.View(viewModel);
        }

        [HttpPost]
        [ValidateAntiForgeryToken]
        [SaveChanges]
        public ActionResult AddMessage(CreateMessageViewModel model)
        {
            if (!ModelState.IsValid)
            {
                return this.Json(null);
            }

            var authorUsername = User.Identity.Name;

            var chat = this.chatService.GetChatById(model.ChatId);

            var chatParticipant = chat
                .Participants
                .FirstOrDefault(x =&gt; x.UserName.ToLower() == authorUsername);

            if (chatParticipant == null)
            {
                // Fix
                return this.Json(null);
            }

            var message = this.chatService.CreateMessage(chat, chatParticipant, model.Text);

            var viewModel = this.mapper.Map&lt;MessageListItemViewModel&gt;(message);
            viewModel.CreatedOn = DateTime.Now;
            
            this.chatNotificationService.NotifyUsers(chat, authorUsername, message.Text);

            return this.PartialView(&quot;_ChatMessage&quot;, viewModel);
        }

        [HttpPost]
        [SaveChanges]
        public ActionResult RemoveNotification(Guid chatId)
        {
            var loggedUser = User.Identity.Name;
            var chat = this.chatService.GetChatById(chatId);

            if (chat != null &amp;&amp; chat.Participants.Any(x =&gt; x.UserName.ToLower() == loggedUser))
            {
                this.chatNotificationService.ClearChatNotification(chat, loggedUser);
                return this.Json(&quot;Notification removed&quot;);
            }

            return new EmptyResult();
        }

        [HttpPost]
        [SaveChanges]
        public ActionResult GetNotificationsCount()
        {
            var loggedUser = User.Identity.Name;

            var count = this
                .userService
                .GetByUsername(loggedUser)
                .Notifications
                .Count(x =&gt; !x.IsDeleted);

            return this.Json(count);
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[25,9,25,152,0],[26,9,26,10,0],[27,13,27,77,0],[28,13,28,67,0],[29,13,29,101,0],[30,13,30,77,0],[32,13,32,44,0],[33,13,33,34,0],[34,13,34,68,0],[35,13,35,44,0],[36,9,36,10,0],[39,9,39,10,0],[40,13,40,84,0],[42,13,45,30,0],[45,30,45,71,0],[45,71,46,27,0],[42,13,46,27,0],[48,13,48,20,0],[48,22,48,30,0],[48,31,48,33,0],[48,34,48,39,0],[49,13,49,14,0],[50,17,50,49,0],[50,49,50,84,0],[50,84,50,86,0],[50,17,50,86,0],[51,17,51,18,0],[52,21,52,41,0],[53,17,53,18,0],[55,17,55,18,0],[56,21,56,40,0],[57,17,57,18,0],[58,13,58,14,0],[60,13,63,33,0],[63,33,63,54,0],[63,54,64,35,0],[64,35,64,53,0],[64,53,66,15,0],[60,13,66,15,0],[68,13,68,41,0],[69,9,69,10,0],[73,9,73,10,0],[74,13,74,49,0],[75,13,75,44,0],[77,13,77,77,0],[79,13,79,80,0],[81,13,81,30,0],[82,13,82,14,0],[83,17,83,127,0],[86,13,86,70,0],[88,13,88,82,0],[90,13,90,41,0],[91,9,91,10,0],[97,9,97,10,0],[98,13,98,37,0],[99,13,99,14,0],[100,17,100,40,0],[103,13,103,53,0],[105,13,105,67,0],[107,13,109,38,0],[109,38,109,76,0],[109,76,109,78,0],[107,13,109,78,0],[111,13,111,41,0],[112,13,112,14,0],[114,17,114,40,0],[117,13,117,93,0],[119,13,119,80,0],[120,13,120,48,0],[122,13,122,90,0],[124,13,124,64,0],[125,9,125,10,0],[130,9,130,10,0],[131,13,131,49,0],[132,13,132,61,0],[134,13,134,60,0],[134,60,134,94,0],[134,94,134,96,0],[134,13,134,96,0],[135,13,135,14,0],[136,17,136,86,0],[137,17,137,58,0],[140,13,140,38,0],[141,9,141,10,0],[146,9,146,10,0],[147,13,147,49,0],[149,13,153,29,0],[153,29,153,41,0],[153,41,153,43,0],[149,13,153,43,0],[155,13,155,37,0],[156,9,156,10,0]]);
    </script>
  </body>
</html>