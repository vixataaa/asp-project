<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\vixat\Desktop\GitRepos\asp-project\src\SecondHand\SecondHand.Web\Controllers\AdvertisementsController.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Linq;
using System.Web.Mvc;
using System.Web;
using AutoMapper;
using AutoMapper.QueryableExtensions;
using Bytes2you.Validation;
using Kendo.Mvc.Extensions;
using Kendo.Mvc.UI;
using SecondHand.Data.Models;
using SecondHand.Services.Data.Common;
using SecondHand.Services.Data.Contracts;
using SecondHand.Web.Common.Constants;
using SecondHand.Web.Infrastructure.Attributes;
using SecondHand.Web.Models.Advertisements;

namespace SecondHand.Web.Controllers
{
    [SaveChanges]
    public class AdvertisementsController : Controller
    {
        private int defaultPageSize;

        private readonly IUsersService userService;
        private readonly IAdvertisementsService advertService;
        private readonly ICategoryService categoryService;
        private readonly IMapper mapper;

        public AdvertisementsController(IUsersService userService, IAdvertisementsService advertService, 
            ICategoryService categoryService, IMapper mapper)
        {
            Guard.WhenArgument(userService, &quot;userService&quot;).IsNull().Throw();
            Guard.WhenArgument(advertService, &quot;advertService&quot;).IsNull().Throw();
            Guard.WhenArgument(categoryService, &quot;categoryService&quot;).IsNull().Throw();
            Guard.WhenArgument(mapper, &quot;mapper&quot;).IsNull().Throw();
            
            this.userService = userService;
            this.advertService = advertService;
            this.categoryService = categoryService;
            this.mapper = mapper;

            this.defaultPageSize = ConfigConstants.DEFAULT_PAGE_SIZE;
        }

        [HttpGet]
        public ActionResult Index(int pageNumber = 1, int pageSize = ConfigConstants.DEFAULT_PAGE_SIZE, string query = &quot;&quot;,
            string sortProperty = &quot;&quot;, SortType sortType = SortType.Descending,
            string category = &quot;&quot;)
        {
            var advertisements = this.advertService
                .GetAdvertisements(pageNumber, pageSize, query, sortProperty, sortType, category)
                .Select(x =&gt; this.mapper.Map&lt;AdvertisementListItemViewModel&gt;(x))
                .ToList();

            var viewModel = new AdvertisementIndexViewModel
            {
                Advertisements = advertisements,
                PageCount = (int)Math.Ceiling((double)this.advertService.LastQueryRecordsCount / pageSize)
            };

            return this.View(viewModel);
        }

        [HttpGet]
        [Authorize]
        public ActionResult AddAdvertisement()
        {
            var categories = this.categoryService
                .GetAll()
                .Select(x =&gt; new SelectListItem() { Text = x.Name, Value = x.Name })
                .ToList();

            var viewModel = new AdvertisementCreationViewModel
            {
                Categories = categories
            };

            return this.View(viewModel);
        }

        [HttpPost]
        [Authorize]
        [ValidateAntiForgeryToken]
        [SaveChanges]
        public ActionResult AddAdvertisement(AdvertisementCreationViewModel model)
        {
            if (!ModelState.IsValid)
            {
                return this.View(model);
            }

            var dbModel = this.mapper.Map&lt;Advertisement&gt;(model);
            var username = this.ControllerContext.HttpContext.User.Identity.Name;
            dbModel.AddedBy = this.userService.GetByUsername(username);

            this.advertService.CreateAdvertisement(dbModel, model.Category);

            return this.RedirectToAction(&quot;Index&quot;);
        }

        [HttpGet]
        public ActionResult Details(Guid id)
        {
            var advertisement = this.advertService.GetById(id);

            if (advertisement == null)
            {
                return this.RedirectToAction(&quot;Index&quot;);
            }

            var viewModel = this.mapper.Map&lt;AdvertisementDetailsViewModel&gt;(advertisement);

            return this.View(viewModel);
        }

        [Authorize]
        public ActionResult MyAdvertisements()
        {
            this.ViewData[&quot;username&quot;] = this.ControllerContext.HttpContext.User.Identity.Name;

            return this.View();
        }

        [Authorize]
        [HttpPost]
        [SaveChanges]
        public ActionResult Delete(Guid id)
        {
            var adv = this.advertService.GetById(id);

            if (adv == null)
            {
                return this.RedirectToAction(&quot;Index&quot;);
            }

            if (adv.AddedBy.UserName != this.ControllerContext.HttpContext.User.Identity.Name)
            {
                return this.RedirectToAction(&quot;Details&quot;, new { id = id });
            }

            this.advertService.Remove(id);

            return this.RedirectToAction(&quot;MyAdvertisements&quot;);
        }

        [Authorize]
        public ActionResult Edit(Guid id)
        {
            var adv = this.advertService.GetById(id);

            if (adv == null)
            {
                return this.RedirectToAction(&quot;Index&quot;);
            }

            if (adv.AddedBy.UserName != this.ControllerContext.HttpContext.User.Identity.Name)
            {
                return this.RedirectToAction(&quot;Details&quot;, new { id = id });
            }

            var viewModel = this.mapper.Map&lt;AdvertisementEditViewModel&gt;(adv);

            return this.View(viewModel);
        }

        [HttpPost]
        [Authorize]
        [ValidateAntiForgeryToken]
        [SaveChanges]
        public ActionResult Edit(AdvertisementEditViewModel model)
        {
            if (!this.ModelState.IsValid)
            {
                return this.View(model);
            }

            var adv = this.advertService.GetById(model.Id);

            if (adv == null)
            {
                return this.RedirectToAction(&quot;Index&quot;);
            }

            if (this.ControllerContext.HttpContext.User.Identity.Name != adv.AddedBy.UserName)
            {
                return this.RedirectToAction(&quot;Details&quot;, new { id = model.Id.ToString() });
            }

            adv.Title = model.Title;
            adv.Description = model.Description;
            adv.Price = model.Price;
            adv.CurrencyType = model.CurrencyType;

            this.advertService.Edit(adv);

            return this.RedirectToAction(&quot;Details&quot;, new { id = model.Id.ToString() });
        }


        public ActionResult UserAdvertisements([DataSourceRequest] DataSourceRequest request, string username)
        {
            var loggedUsername = username;

            var result = this.advertService
                .GetUserAdvertisements(loggedUsername)
                .Select(x =&gt; this.mapper.Map&lt;AdvertisementListItemViewModel&gt;(x))
                .ToDataSourceResult(request);

            return this.Json(result);
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[29,9,30,62,1],[31,9,31,10,1],[32,13,32,77,1],[33,13,33,81,1],[34,13,34,85,1],[35,13,35,67,1],[37,13,37,44,1],[38,13,38,48,1],[39,13,39,52,1],[40,13,40,34,1],[42,13,42,70,1],[43,9,43,10,1],[49,9,49,10,1],[50,13,52,30,1],[52,30,52,80,1],[52,80,53,27,1],[50,13,53,27,1],[55,13,59,15,1],[61,13,61,41,1],[62,9,62,10,1],[67,9,67,10,1],[68,13,70,30,1],[70,30,70,84,1],[70,84,71,27,1],[68,13,71,27,1],[73,13,76,15,1],[78,13,78,41,1],[79,9,79,10,1],[86,9,86,10,1],[87,13,87,37,1],[88,13,88,14,1],[89,17,89,41,1],[92,13,92,65,1],[93,13,93,82,1],[94,13,94,72,1],[96,13,96,77,1],[98,13,98,51,1],[99,9,99,10,1],[103,9,103,10,1],[104,13,104,64,1],[106,13,106,39,1],[107,13,107,14,1],[108,17,108,55,1],[111,13,111,91,1],[113,13,113,41,1],[114,9,114,10,1],[118,9,118,10,1],[119,13,119,95,1],[121,13,121,32,1],[122,9,122,10,1],[128,9,128,10,1],[129,13,129,54,1],[131,13,131,29,1],[132,13,132,14,1],[133,17,133,55,1],[136,13,136,95,1],[137,13,137,14,1],[138,17,138,74,1],[141,13,141,43,1],[143,13,143,62,1],[144,9,144,10,1],[148,9,148,10,1],[149,13,149,54,1],[151,13,151,29,1],[152,13,152,14,1],[153,17,153,55,1],[156,13,156,95,1],[157,13,157,14,1],[158,17,158,74,1],[161,13,161,78,1],[163,13,163,41,1],[164,9,164,10,1],[171,9,171,10,1],[172,13,172,42,1],[173,13,173,14,1],[174,17,174,41,1],[177,13,177,60,1],[179,13,179,29,1],[180,13,180,14,1],[181,17,181,55,1],[184,13,184,95,1],[185,13,185,14,1],[186,17,186,91,1],[189,13,189,37,1],[190,13,190,49,1],[191,13,191,37,1],[192,13,192,51,1],[194,13,194,42,1],[196,13,196,87,1],[197,9,197,10,1],[201,9,201,10,1],[202,13,202,43,1],[204,13,206,30,1],[206,30,206,80,1],[206,80,207,46,1],[204,13,207,46,1],[209,13,209,38,1],[210,9,210,10,1]]);
    </script>
  </body>
</html>